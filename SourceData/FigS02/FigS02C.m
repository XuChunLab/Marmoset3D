


%% m231127fullyCoverage


paths={ % 230717 Nature
    % glob.glob(r"X:\230412to230427TreeD\230[0-9][0-9][0-9]n*\2023_0*\DLCpredwcy4BPYB.mat")
 'X:\\230412to230427TreeD\\230413Nature\\2023_04_13_13_49_31_592762\\',
 'X:\\230412to230427TreeD\\230419Nature\\2023_04_19_14_29_30_131675\\',
 'X:\\230412to230427TreeD\\230425Nature\\2023_04_25_14_36_12_788610\\',
 'X:\\230412to230427TreeD\\230427Nature\\2023_04_27_15_26_18_700427\\',
    % glob.glob(r"V:\chuanyaoANDjiankang\3Dproject_DataFormXuGroupShare\230[0-9][0-9][0-9]n*\2023_0*\DLCpredwcy4BPYB.mat")
%  'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230314Nature\\2023_03_14_14_30_08_253778\\',
%  'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230315Nature\\2023_03_15_15_00_16_056237\\',
%  'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230317Nature\\2023_03_17_16_18_38_867876\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230320Nature\\2023_03_20_14_27_51_678807\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230321Nature\\2023_03_21_15_25_00_472190\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230322Nature\\2023_03_22_15_55_47_040798\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230323Nature\\2023_03_23_12_22_07_047315\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230327Nature\\2023_03_27_15_37_04_891288\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230328Nature\\2023_03_28_14_19_28_253934\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230329Nature\\2023_03_29_16_28_03_448088\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230330Nature\\2023_03_30_14_33_37_501992\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230403Nature\\2023_04_03_14_50_26_909197\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230404Nature\\2023_04_04_16_03_58_597203\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230406Nature\\2023_04_06_14_55_31_192529\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230411Nature\\2023_04_11_14_42_02_689582\\',

    % glob.glob(r"X:\230412to230427TreeD\230[0-9][0-9][0-9]X*\2023_0*\DLCpredwcy4BPYB.mat")
 'X:\\230412to230427TreeD\\230412Xiaoquan\\2023_04_12_15_54_24_364959\\',
 'X:\\230412to230427TreeD\\230418Xiaoquan\\2023_04_18_14_08_26_909499\\',
 'X:\\230412to230427TreeD\\230424Xiaoquan\\2023_04_24_15_38_27_249516\\',
    % glob.glob(r"V:\chuanyaoANDjiankang\3Dproject_DataFormXuGroupShare\230[0-9][0-9][0-9]X*\2023_0*\DLCpredwcy4BPYB.mat")
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230323Xiaoquan\\2023_03_23_14_49_57_541477\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230327Xiaoquan\\2023_03_27_14_35_42_975502\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230328Xiaoquan\\2023_03_28_13_25_30_629689\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230329Xiaoquan\\2023_03_29_15_20_23_589159\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230330Xiaoquan\\2023_03_30_15_49_41_647800\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230403Xiaoquan\\2023_04_03_13_34_40_770707\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230404Xiaoquan\\2023_04_04_14_52_40_297949\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230406Xiaoquan\\2023_04_06_16_02_16_496397\\',

 'X:\\230412to230427TreeD\\230413Science\\2023_04_13_14_51_38_833897\\',
 'X:\\230412to230427TreeD\\230418Science\\2023_04_18_15_08_23_932332\\',
 'X:\\230412to230427TreeD\\230425Science\\2023_04_25_15_34_32_017552\\',
 'X:\\230412to230427TreeD\\230427Science\\2023_04_27_14_14_47_350721\\',
 %'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230314Science\\2023_03_14_15_41_15_604354\\',
 %'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230315Science\\2023_03_15_16_03_54_258695\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230321Science\\2023_03_21_14_15_34_594587\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230323Science\\2023_03_23_13_32_20_710438\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230327Science\\2023_03_27_16_39_00_254602\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230330Science\\2023_03_30_13_28_27_513175\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230406Science\\2023_04_06_13_45_29_514628\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230411Science\\2023_04_11_15_48_55_073184\\',

 %'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230317Science\\2023_03_17_15_04_28_627343\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230320Science\\2023_03_20_16_34_30_060762\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230322science\\2023_03_22_14_29_39_070654\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230328Science\\2023_03_28_15_44_16_757990\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230329Science\\2023_03_29_13_59_08_692082\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230403Science\\2023_04_03_16_39_13_461103\\',
 'V:\\chuanyaoANDjiankang\\3Dproject_DataFormXuGroupShare\\230404Science\\2023_04_04_13_52_10_923013\\',
 'X:\\230412to230427TreeD\\230412Science\\2023_04_12_14_47_05_312503\\',
 'X:\\230412to230427TreeD\\230419Science\\2023_04_19_16_02_49_475257\\',
 'X:\\230412to230427TreeD\\230424Science\\2023_04_24_14_41_59_266285\\',
    }
close all

%F1M=zeros(size(paths,1),6)*nan;
F1M=cell(1,size(paths,1));

for pathi=1:size(paths,1)
    path=paths{pathi};
    load([path,'DLCpredwcy4BPYB.mat']);
    %load(path);
    
experimentpath=path;    
[~,temp1]=textread([experimentpath,'output1.txt'],'%s%s');secend1=zeros(1,length(temp1));
[~,temp2]=textread([experimentpath,'output2.txt'],'%s%s');secend2=zeros(1,length(temp1));
[~,temp3]=textread([experimentpath,'output3.txt'],'%s%s');secend3=zeros(1,length(temp1));
[~,temp4]=textread([experimentpath,'output4.txt'],'%s%s');secend4=zeros(1,length(temp1));

for i=1:length(temp1)
    secend1(i)=str2num(temp1{i}(1:2))*60*60+str2num(temp1{i}(4:5))*60+str2num(temp1{i}(7:8))+str2num(temp1{i}(9:15));
    secend2(i)=str2num(temp2{i}(1:2))*60*60+str2num(temp2{i}(4:5))*60+str2num(temp2{i}(7:8))+str2num(temp2{i}(9:15));
    secend3(i)=str2num(temp3{i}(1:2))*60*60+str2num(temp3{i}(4:5))*60+str2num(temp3{i}(7:8))+str2num(temp3{i}(9:15));
    secend4(i)=str2num(temp4{i}(1:2))*60*60+str2num(temp4{i}(4:5))*60+str2num(temp4{i}(7:8))+str2num(temp4{i}(9:15));
end
vediotime=(secend1+secend2+secend3+secend4)/4.0;
reserved_pred=pred;
pred=[];
reserved_vediotime=vediotime;
t=vediotime;
fs=20;
dot=cell(1,4);
for j=1:4
    pred=[];
for i=1:3
    yg=reserved_pred(:,i,j)';
    ty=t(2):(1/fs):t(end-1);
    y = interp1(t,yg,ty,'nearest');%plot(ty,y,'r'); hold on ; plot(t, yg,'k')
    y=smoothdata(smoothdata(y,'movmedian',3),'gaussian',5); 
    pred=[pred,y'];
end
dot{j}=pred;
end
vediotime=ty;

threeDplace=dot{1};
dot{1}=[threeDplace(:,3),threeDplace(:,2),750-threeDplace(:,1)];
threeDplace=dot{2};
dot{2}=[threeDplace(:,3),threeDplace(:,2),750-threeDplace(:,1)];
threeDplace=dot{3};
dot{3}=[threeDplace(:,3),threeDplace(:,2),750-threeDplace(:,1)];
temp= (dot{1}+dot{2})*1000/2-dot{3}*1000;
facedirection=temp./repmat(sqrt(temp(:,1).^2+temp(:,2).^2+temp(:,3).^2),1,3);
if pathi>10
    facedirection=-facedirection;
end
threeDplace=dot{4};
data_3d=[threeDplace(:,3),threeDplace(:,2),750-threeDplace(:,1)];
threeDplace=[threeDplace(:,3),threeDplace(:,2),750-threeDplace(:,1)];
figure
plot3(data_3d(:,1),data_3d(:,2),data_3d(:,3))
xlabel('x (mm)','FontName','Calibri','FontSize',20);
ylabel('y (mm)','FontName','Calibri','FontSize',20);
zlabel('z (mm)','FontName','Calibri','FontSize',20);

pred=threeDplace;
data_3d=pred;
speed=pred*nan;
frame_period=0.05;
for i = 2:size(pred,1)-1
    speed(i,:)=(data_3d(i+1,:)-data_3d(i-1,:))/(2*frame_period);
end

% 230430 travel , defination copy form m230424facedirection
linespeed=sqrt(speed(:,1).^2+speed(:,2).^2+speed(:,3).^2);
linespeed=smoothdata(linespeed,'gaussian',5);
temp=linespeed*0;
temp(find(linespeed>=25))=1; % 因为是头朝向 速度 不要求
flag=1;
tempx=[0,temp'];
tempy=tempx*0;
for i=2:length(tempx)
    if tempx(i)==1
        tempy(i)=flag;
    end
    if (tempx(i)-tempx(i-1))==-1
        flag=flag+1;
    end
end
temp=tempy(2:end);
clear tempx tempy
%plot(temp)
travel=cell(1,1);
flag=1;
okframe=[];
for i=1:max(temp)
    tempp=find(temp==i);
    if length(tempp)>=20 % 因为是头朝向 速度 不要求
        tempp(end-2:end)=[];% 因为是头朝向 速度 不要求
        tempp(1:3)=[];% 因为是头朝向 速度 不要求
        travel{1,flag}=tempp;
        okframe=[okframe,tempp];
        flag=flag+1;
    end
end
linespeed=setdiff([1:size(pred,1)],okframe);
%

a=union(find(data_3d(:,1)<0),find(data_3d(:,1)>1500));
b=union(find(data_3d(:,2)<0),find(data_3d(:,2)>1500));
c=union(find(data_3d(:,3)<0),find(data_3d(:,3)>750));
outspace=union(union(a,b),c);
noneedfram=union(outspace,linespeed);

needfram=setdiff([1:size(pred,1)],noneedfram);


data_3d=pred(needfram,:);
%visitplace=zeros(20,20,1);
visitplace=zeros(6,6,3);%10 10 5 150 %6 6 3 250
for i=1:size(data_3d,1)
    temp=[];
    if ~isnan(data_3d(i,1))
        temp=ceil(data_3d(i,:)/250);
        visitplace(temp(1),temp(2),temp(3))=visitplace(temp(1),temp(2),temp(3))+1;
    end
end
visitplace=visitplace/size(data_3d,1);
F1M{1,pathi}=visitplace;

pathi
end




coverage=[]
for i=1:46
    coverage=[coverage,sum(sum(sum(~~(F1M{1, i}))))/(6*6*3)];
end

mean(coverage)

figure
scatter(ones(1,16)*1,coverage(1:16))
hold on
scatter(ones(1,11)*2,coverage(17:27))
hold on
scatter(ones(1,19)*3,coverage(28:46))
hold on
scatter(ones(1,46)*4,coverage)
hold on

ttest2(coverage(1:16),coverage(17:27))
ttest2(coverage(28:46),coverage(17:27))
ttest2(coverage(1:16),coverage(28:46))
ylim([0 1])
xlim([0 5])

plot([-0.3 0.3]+1,[mean(coverage(1:16)),mean(coverage(1:16))])
hold on
plot([-0.3 0.3]+2,[mean(coverage(17:27)),mean(coverage(17:27))])
hold on
plot([-0.3 0.3]+3,[mean(coverage(28:46)),mean(coverage(28:46))])
hold on
plot([-0.3 0.3]+4,[mean(coverage),mean(coverage)])
hold on
%% oringinal

coverage=[]
for i=1:16
    coverage=[coverage,sum(sum(sum(~~(Batch2Behavior230717Vsitingetc_Nature{1, i}))))/4000];
end
for i=1:19
    coverage=[coverage,sum(sum(sum(~~(Batch2Behavior230717Vsitingetc_Science{1, i}))))/4000];
end
for i=1:11
    coverage=[coverage,sum(sum(sum(~~(Batch2Behavior230717Vsitingetc_Xiaoquan{1, i}))))/4000];
end